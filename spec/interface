# vim:ft=Marchfile
module user

UserAPI interface {

    GET "/user" {
        set users from UserService do List \
            or halt with INTERNAL_SERVER_ERROR and CouldNotListUser

        return OK and users
    }

    POST "/user" {
        set user from REQUEST decode BODY as UserCreateRequest \
            or halt with BAD_REQUEST and InvalidUserCreateRequest

        set newUser from UserService do Create with user {
            when UserCreateRequestValidationFailed {
                return BAD_REQUEST and FAILURE
            }
            when FAILURE {
                return INTERNAL_SERVER_ERROR and CouldNotCreateUser
            }
        }

        return CREATED and newUser
    }

    GET "/user/:id" {
        set userID from PATH decode id as int \
            or halt with BAD_REQUEST and InvalidUserID

        set user from UserService do Lookup with userID \
            or halt with INTERNAL_SERVER_ERROR and CouldNotListUser

        return OK and user
    }

    PUT "/user/:id" {
        set userID from PATH decode id as int \
            or halt with BAD_REQUEST and InvalidUserID

        set req from REQUEST decode BODY as UserUpdateRequest \
            or halt with BAD_REQUEST and InvalidUserCreateRequest

        set req from UserService do Update with id and req {
            when UserNotFound {
                return NOT_FOUND and UserNotFound
            }
            when FAILURE {
                return INTERNAL_SERVER_ERROR and CouldNotUpdateUser
            }
        }

        return OK and user
    }
}
